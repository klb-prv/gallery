---
import Modal from "./Modal.astro";

const { imgSrc, allImages, initialIndex = 0 } = Astro.props;

const uniqueId = `image-preview-${crypto.randomUUID()}`;
let currentIndex = initialIndex;
---

<style>
  dialog::backdrop {
    background: rgba(33, 31, 31, 0.6);
  }
</style>

<div
  id={`trigger-${uniqueId}`}
  class="w-[450px] h-[250px] my-4 rounded-lg flex justify-center items-center text-3xl cursor-pointer hover:drop-shadow-2xl hover:border-2 hover:border-white transition"
  style="transition: all .1s ease-in-out;"
  onclick={`document.getElementById('${uniqueId}').showModal()`}
>
  <img
    class="w-[445px] h-[245px] rounded-lg object-cover"
    src={imgSrc}
    alt="Picture"
    width="1280"
  />
</div>

<Modal id={uniqueId}>
  <button slot="close" class="image-popup" type="button" id={`${uniqueId}-close`}>
    &#10006; Close
  </button>

  <main slot="main" class="flex flex-col items-center justify-center">
    <img
      id={`${uniqueId}-img`}
      src={imgSrc}
      alt="Picture"
      width="1280"
      class="rounded-lg max-w-full max-h-[80vh] object-contain"
    />
    <div class="flex gap-4 mt-4">
      <button
        type="button"
        id={`${uniqueId}-prev`}
        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
      >
        Prev
      </button>
      <button
        type="button"
        id={`${uniqueId}-next`}
        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
      >
        Next
      </button>
    </div>
  </main>
</Modal>

<script lang="ts">
  (() => {
    // Directly using Astro props
    const uniqueId = `${Astro.props.uniqueId}`;
    const images = ${JSON.stringify(allImages)}; // Interpolating the allImages array
    let currentIndex = ${initialIndex};  // Interpolating the initialIndex

    const trigger = document.getElementById(`trigger-${uniqueId}`)!;
    const modal = document.getElementById(uniqueId)!;
    const imgEl = document.getElementById(`${uniqueId}-img`)!;
    const closeBtn = document.getElementById(`${uniqueId}-close`)!;
    const prevBtn = document.getElementById(`${uniqueId}-prev`)!;
    const nextBtn = document.getElementById(`${uniqueId}-next`)!;

    function updateImage(index: number) {
      if (index < 0) index = images.length - 1;
      if (index >= images.length) index = 0;
      currentIndex = index;
      imgEl.src = images[currentIndex];
    }

    trigger.addEventListener('click', () => {
      modal.showModal();
      updateImage(currentIndex);
    });

    closeBtn.addEventListener('click', () => {
      modal.close();
    });

    prevBtn.addEventListener('click', () => {
      updateImage(currentIndex - 1);
    });

    nextBtn.addEventListener('click', () => {
      updateImage(currentIndex + 1);
    });
  })();
</script>
