---
import Modal from "./Modal.astro";

// Odbierz dane z props
const { imgSrc, allImages = [], initialIndex = 0 } = Astro.props;

// Generuj unikalne ID dla modalu
const uniqueId = `image-preview-${crypto.randomUUID()}`;
---

<style>
  dialog::backdrop {
    background: rgba(33, 31, 31, 0.6);
  }
</style>

<div
  id={`trigger-${uniqueId}`}
  class="w-[450px] h-[250px] my-4 rounded-lg flex justify-center items-center text-3xl cursor-pointer hover:drop-shadow-2xl hover:border-2 hover:border-white transition"
  style="transition: all .1s ease-in-out;"
  data-all-images="{allImages}" <!-- Przekształcamy tablicę do JSON -->
  data-initial-index={initialIndex} <!-- Przesyłamy index -->
>
  <img
    class="w-[445px] h-[245px] rounded-lg object-cover"
    src={imgSrc}
    alt="Picture"
    width="1280"
  />
</div>

<Modal id={uniqueId}>
  <button slot="close" class="image-popup" type="button" id={`${uniqueId}-close`}>
    ✖ Close
  </button>

  <main slot="main" class="flex flex-col items-center justify-center">
    <img
      id={`${uniqueId}-img`}
      src={imgSrc}
      alt="Picture"
      width="1280"
      class="rounded-lg max-w-full max-h-[80vh] object-contain"
    />
    <div class="flex gap-4 mt-4">
      <button
        type="button"
        id={`${uniqueId}-prev`}
        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled={allImages?.length <= 1}
      >
        Prev
      </button>
      <button
        type="button"
        id={`${uniqueId}-next`}
        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled={allImages?.length <= 1}
      >
        Next
      </button>
    </div>
  </main>
</Modal>

<script>
// Poczekaj, aż cała strona się załaduje
window.addEventListener('load', function () {
  // Pobierz elementy DOM
  const trigger = document.getElementById(`trigger-${uniqueId}`);
  const modal = document.getElementById(uniqueId);
  const imgEl = document.getElementById(`${uniqueId}-img`);
  const closeBtn = document.getElementById(`${uniqueId}-close`);
  const prevBtn = document.getElementById(`${uniqueId}-prev`);
  const nextBtn = document.getElementById(`${uniqueId}-next`);

  // Pobierz dane z atrybutów data- w HTML-u
  const allImages = JSON.parse(trigger.getAttribute('data-all-images'));
  let currentIndex = parseInt(trigger.getAttribute('data-initial-index'), 10);

  function updateImage(index) {
    if (!allImages || allImages.length === 0) return;
    if (index < 0) index = allImages.length - 1;
    if (index >= allImages.length) index = 0;
    currentIndex = index;
    imgEl.src = allImages[currentIndex];
  }

  if (trigger && modal && imgEl && closeBtn && prevBtn && nextBtn) {
    // Upewnij się, że modal jest zamknięty przy załadowaniu strony
    if (modal.open) {
      console.warn("Modal był otwarty przy załadowaniu strony, zamykam go.");
      modal.close();
    }

    trigger.addEventListener('click', function () {
      console.log("Kliknięto przycisk, otwieram modal.");
      modal.showModal();
      updateImage(currentIndex);
    });

    closeBtn.addEventListener('click', function () {
      console.log("Kliknięto przycisk zamknięcia.");
      modal.close();
    });

    prevBtn.addEventListener('click', function () {
      console.log("Kliknięto przycisk poprzedni.");
      updateImage(currentIndex - 1);
    });

    nextBtn.addEventListener('click', function () {
      console.log("Kliknięto przycisk następny.");
      updateImage(currentIndex + 1);
    });
  } else {
    console.error("Nie znaleziono jednego lub więcej elementów DOM:", {
      trigger, modal, imgEl, closeBtn, prevBtn, nextBtn
    });
  }
});
</script>
